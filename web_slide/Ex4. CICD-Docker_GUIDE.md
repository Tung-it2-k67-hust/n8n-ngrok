# DEVELOPER DECISION GUIDE: Ex4. CICD-Docker.pdf

> Generated by OpenRouter (xiaomi/mimo-v2-flash:free) on 2026-01-06 17:39:58



<!-- CHUNK 1-7 -->

# DEVELOPER DECISION GUIDE: CI/CD với Docker & GitHub Actions

## SECTION 1: CORE MENTAL MODEL

### 1.1. Core Definitions (Khái Niệm Chính)

*   **CI/CD (Continuous Integration/Continuous Deployment - Tích Hợp & Triển Khai Liên Tục):**
    *   **Definition:** Quy trình tự động hóa để kiểm thử và giao phần mềm (Build, Test, Deploy).
    *   **Real-world mental model:** Nó là một "nhà máy ảo" mà mỗi khi bạn `git push`, nó sẽ tự động thực hiện các công việc lặp lại (như đóng gói phần mềm) thay vì bạn làm thủ công.
*   **Docker Image (Ảnh Docker):**
    *   **Definition:** Bản thiết kế (blueprint) tĩnh chứa mã nguồn, thư viện và phụ thuộc để chạy ứng dụng.
    *   **Real-world mental model:** yabanc là một file `.iso` của hệ điều hành, nhưng nhẹ hơn và chỉ chứa riêng ứng dụng của bạn.
*   **Docker Container (Rì Container):**
    *   **Definition:** Phiên bản chạy động của Image.
    *   **Real-world mental model:** Khi bạn chạy Image, bạn tạo ra một Container. Giống như bạn cài Windows (Image) và mở một cửa sổ Windows (Container) để làm việc.
*   **GitHub Actions (Tự Động Hóa GitHub):**
    *   **Definition:** Nền tảng tự động hóa CI/CD được tích hợp ngay trong GitHub.
    *   **Real-world mental model:** Một người trợ lý ảo luôn lắng nghe sự thay đổi code (`git push`), sau đó thực thi các lệnh bạn đã định sẵn (như Build Docker, Push Docker).

### 1.2. Why CI/CD + Docker?

*   **Khắc phục vấn đề "Works on my machine":** Docker đảm bảo ứng dụng chạy giống nhau từ máy Dev -> Testing -> Production.
*   **Tốc độ:** GitHub Actions tự động 100%, không cần gõ lệnh thủ công mỗi khi sửa code.
*   **Bảo mật:** Sử dụng **GitHub Secrets** để quản lý token/mật khẩu thay vì hardcode.

---

## SECTION 2: DECISION TABLES (KHI NÀO DÙNG GÌ?)

### 2.1. Dockerfile Instructions

| Use case (Tình huống) | Should use (Nên dùng) | Why (Tại sao) | Common mistake (Sai lầm thường gặp) |
| :--- | :--- | :--- | :--- |
| **Cài đặt môi trường chạy** | `FROM node:18-alpine` | `Alpine` nhẹ nhất, tải nhanh, bảo mật tốt hơn các image lớn. | Dùng image `latest` hoặc `ubuntu` nặng nề không cần thiết. |
| **Tối ưu cache build** | `COPY package*.json ./` <br> `RUN npm install` | Cài phụ thuộc **trước** khi copy source code. Nếu source thay đổi nhưng package không thay đổi, Docker dùng cache cũ, rất nhanh. | Copy tất cả (`COPY . .`) trước khi `npm install` -> mỗi dòng code sửa đều phải tải lại thư viện. |
| **Bảo mật container** | `USER node` (Sau khi setup) | Không chạy app với quyền `root` (mặc định của Docker). Nếu hacker chui vào Container, chúng cũng không có quyền quản trị. | Để mặc định `root`. Dễ bị tấn công nếu có lỗ hổng. |
| **Chạy App** | `CMD ["node", "index.js"]` (Exec form) | Lệnh chạy chính xác, bắt signal (SIGTERM) tốt để tắt进程 đúng cách. | `CMD node index.js` (Shell form) -> Khởi động một process cha лишний, khó quản lý. |

### 2.2. GitHub Actions Workflow Strategy

| Use case (Tình huống) | Should use (Nên dùng) | Why (Tại sao) | Common mistake (Sai lầm thường gặp) |
| :--- | :--- | :--- | :--- |
| **Chạy khi nào?** | `on: push: branches: [ main ]` | Chủ động kiểm soát nhánh chính (production/staging). | Chạy trên mọi nhánh -> Lãng phí tài nguyên build. |
| **Quản lý Secret** | `secrets.DOCKERHUB_TOKEN` | API Key/Token được lưu trữ an toàn, không bao giờ lộ trong log hay code. | Hardcode password trong file `.yml` -> Rất nguy hiểm, bị lộ public ngay. |
| **Deploy** | Sử dụng `needs: build-and-push` | Đảm bảo chỉ deploy khi Build thành công 100%. | Bỏ qua dependency -> Cố deploy khi image chưa có hoặc bị lỗi. |

---

## SECTION 3: ARCHITECTURE & RELATIONSHIPS

### Workflow Flowchart (Luồng Hoạt Động)

```text
[ Developer Code ]
      |
      | git push origin main
      v
[ GitHub Repository ]
      |
      | Webhook kích hoạt
      v
[ GitHub Actions (Runner) ]
      |--------------------------------|
      | 1. Checkout Code               |  (Lấy source)
      | 2. Setup Docker Buildx         |  (Chuẩn bị tool build)
      | 3. Login Docker Hub (Secrets)  |  (Xác thực an toàn)
      | 4. Build & Push Image          |  (Tạo & Upload ảo)
      |--------------------------------|
                |
                | (Image: username/app:tag)
                v
      [ Docker Hub ]
                |
                | (Chờ hoặc Trigger)
                v
      [ Production Server ]
                |
                | docker pull & run
                v
      [ Container Running ]
```

### Component Hierarchy (Mối quan hệ Component)

*   **Repository (GitHub)**: Nơi chứa code và file cấu hình `.yml`.
*   **Secrets**: Kho chứa key (bên ngoài code), cung cấp cho Workflow khi cần.
*   **Workflow (YML)**: File định nghĩa "Kế hoạch" (Steps).
*   **Action**: Một thư viện code sẵn có (ví dụ `docker/login-action`) để thực thi 1 bước c cụ thể.

---

## SECTION 4: CODE PATTERNS (READY TO USE)

### Pattern 1: The Optimal Dockerfile (Multi-stage / Optimized)

*   **Khi nào dùng:** Luôn dùng cho các dự án Node.js/Python.
*   **Tại sao đúng:** Tách biệt dependency installation và source code copy giúp build cực nhanh khi chỉ sửa code.

```dockerfile
# 1. Base Image (Giai đoạn build)
FROM node:18-alpine AS builder

WORKDIR /app

# Copy package trước để cache dependency
COPY package*.json ./
RUN npm install

# Copy source code
COPY . .

# CMD ["node", "index.js"] (Chỉ cần dùng ở stage cuối)

# 2. Production Image (Giai đoạn chạy)
FROM node:18-alpine

WORKDIR /app

# Copy node_modules từ builder
COPY --from=builder /app/node_modules ./node_modules
COPY . .

EXPOSE 3000

# Chạy server
CMD ["node", "index.js"]
```

### Pattern 2: GitHub Actions CI/CD Pipeline

*   **Khi nào dùng:** Khi bạn muốn tự động Build và Push image lên Docker Hub.
*   **Tại sao đúng:** Sử dụng `build-push-action` chuẩn hóa quy trình, tự động xử lý cache và log.

```yaml
name: CI/CD Docker Push

on:
  push:
    branches: [ "main" ]

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      # Bước 1: Lấy code từ Repo
      - name: Checkout code
        uses: actions/checkout@v4

      # Bước 2: Setup Docker CLI
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Bước 3: Đăng nhập vào Docker Hub (Bằng Secret)
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Bước 4: Build và Push
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Đổi tên theo tài khoản bạn: dockerhub-username/image-name:tag
          tags: yourdockeruser/it4409-ex4:latest
```

---

## SECTION 5: ANTI-PATTERNS & WARNINGS

| Anti-Pattern (Lối sai) | Why Dangerous (Tại sao nguy hiểm) |
| :--- | :--- |
| **Hardcode Credentials** <br> (Ghi đè password trực tiếp vào file code/yml) | Bất kỳ ai xem code Public hoặc lướt qua Repository đều thấy mật khẩu, API Key. Hacker sẽ đánh cắp và sử dụng tài nguyên của bạn (coin mining) hoặc xóa dữ liệu. |
| **Using `latest` tag blindly** <br> (Luôn dùng `:latest`) | Khó rollback. Khi có bug, bạn không biết version `:latest` hiện tại là version nào để quay lại. Nên dùng versioning rõ ràng (v1.0, v1.1). |
| **Running as Root inside Container** <br> (Không tạo User riêng) | Nếu Container bị breakout, hacker có quyền quản trị toàn bộ máy chủ (Server) chứa Container đó. |
| **COPY . . trước khi npm install** | Docker sẽ phải chạy lại `npm install` mỗi khi bạn sửa một dòng code, dù không sửa file `package.json`. Làm chậm build và tốn băng thông. |

---

## SECTION 6: MASTER CHEAT SHEET

### Quick Reference Rules

1.  **Dockerfile:**
    *   `COPY package*.json` -> `RUN npm install` (Luôn luôn).
    *   `EXPOSE` port mà app chạy (ví dụ 3000).
    *   `CMD` dùng mảng `["...", "..."]`.
2.  **GitHub Actions:**
    *   File phải để tại: `.github/workflows/tên-file.yml`.
    *   Dùng `${{ secrets.TÊN_KEY }}` cho mọi thứ nhạy cảm.
    *   Luôn kiểm tra tab **Actions** để xem log lỗi.

### Decision Logic (If-Else)

*   **IF:** Bạn muốn build image mới khi code thay đổi.
    *   **THEN:** Tạo file `.github/workflows/*.yml` với event `on: push`.
*   **IF:** Docker Hub yêu cầu đăng nhập.
    *   **THEN:** Tạo **Personal Access Token** trên Docker Hub -> Lưu vào **Repository Secrets** trên GitHub.
*   **IF:** Dockerfile build chậm.
    *   **THEN:** Kiểm tra lại thứ tự `COPY`. Đảm bảo `COPY package...` nằm trên `COPY . .`.

### Top 3 Things to Remember (Quan trọng nhất)

1.  **Secrets là bắt buộc:** Không có token, CI/CD không đẩy được image lên Docker Hub.
2.  **Context là `.`:** Khi build, context `.` nghĩa là "dùng file trong thư mục hiện tại".
3.  **Đọc Log:** 90% lỗi c cực kỳ dễ thấy ngay trong log màu đỏ của GitHub Actions (thiếu file, sai command, permission denied).